import streamlit as st
import pandas as pd
import plotly.express as px
import os
from datetime import datetime

# --- CONFIGURATION ---
st.set_page_config(page_title="TIA Quality Control", page_icon="üõ°Ô∏è", layout="wide")
EXCEL_FILE = "suivi_qualite.xlsx"

# --- STRUCTURE DES DONN√âES (Dictionnaire de d√©pendances) ---
# Vous pouvez modifier ces listes avec vos vrais noms de fournisseurs
SITES_DATA = {
    "Site Lyon": ["MERU", "ABC Parts", "SteelCo"],
    "Site Madrid": ["Iberia Components", "MERU", "Madrid Logistics"],
    "Site Tanger": ["Atlas Tech", "North Supply", "Maghreb Parts", "Tanger Fab"]
}

# --- LOGIQUE DE DONN√âES ---
def charger_donnees():
    if os.path.exists(EXCEL_FILE):
        try:
            df = pd.read_excel(EXCEL_FILE)
            for col in ["Passage", "Part Number"]:
                if col not in df.columns:
                    df[col] = "N/A"
            df['Date'] = pd.to_datetime(df['Date'])
            return df
        except:
            return creer_df_vide()
    return creer_df_vide()

def creer_df_vide():
    return pd.DataFrame(columns=[
        "Date", "Main Company", "Site", "Supplier", 
        "Job", "Passage", "Part Number", "Failures", "Quantity"
    ])

def sauvegarder_donnees(new_df):
    if os.path.exists(EXCEL_FILE):
        df_existing = pd.read_excel(EXCEL_FILE)
        df_final = pd.concat([df_existing, new_df], ignore_index=True)
    else:
        df_final = new_df
    df_final.to_excel(EXCEL_FILE, index=False)

df_global = charger_donnees()

# --- INTERFACE ---
st.title("üõ°Ô∏è TIA - Syst√®me de Suivi Qualit√©")

with st.expander("‚ûï Enregistrer une nouvelle d√©faillance (Failure)", expanded=True):
    # Utilisation d'un formulaire pour la validation finale
    with st.form("form_saisie", clear_on_submit=True):
        c1, c2 = st.columns(2)
        
        with c1:
            # 1. S√©lection du Site
            site_list = list(SITES_DATA.keys())
            site = st.selectbox("S√©lectionner le Site (Factory)", site_list)
            
            # 2. S√©lection du Fournisseur (D√âPENDANT DU SITE CHOISI)
            # Cette liste se met √† jour automatiquement selon le choix au-dessus
            supplier_list = SITES_DATA[site]
            supplier = st.selectbox("S√©lectionner le Fournisseur", supplier_list)
            
            job = st.text_input("Num√©ro de Job")
            passage = st.selectbox("Num√©ro de Passage", ["Passage 1", "Passage 2", "Passage 3", "Retouche"])
            
        with c2:
            part_number = st.text_input("Part Number (N¬∞ de Pi√®ce)")
            failures = st.multiselect("Types de Failure", ["Wrong Colour", "Wrong Size", "Damage", "Missing Part"])
            qty = st.number_input("Quantit√© (1-50)", 1, 50, 1)
            date_s = st.date_input("Date du constat", datetime.now())
        
        if st.form_submit_button("Valider l'enregistrement"):
            if job and part_number:
                new_row = pd.DataFrame({
                    "Date": [pd.to_datetime(date_s)], "Main Company": ["TIA"],
                    "Site": [site], "Supplier": [supplier], "Job": [job],
                    "Passage": [passage], "Part Number": [part_number],
                    "Failures": [", ".join(failures)], "Quantity": [qty]
                })
                sauvegarder_donnees(new_row)
                st.success(f"Enregistr√© pour {supplier} sur le {site} !")
                st.rerun()
            else:
                st.error("‚ö†Ô∏è Champs obligatoires : Job et Part Number.")

# --- STATISTIQUES ---
if not df_global.empty:
    st.divider()
    st.header("üìä Tableau de Bord & Statistiques")
    
    st.sidebar.header("üîç Filtres")
    unique_sites = df_global['Site'].unique().tolist()
    selected_site_filter = st.sidebar.multiselect("Filtrer par Site", unique_sites, default=unique_sites)
    
    df_filt = df_global[df_global['Site'].isin(selected_site_filter)]

    k1, k2, k3 = st.columns(3)
    k1.metric("Total Rejets", f"{df_filt['Quantity'].sum()} pcs")
    k2.metric("Part Numbers Impact√©s", df_filt['Part Number'].nunique())
    k3.metric("Sites Actifs", df_filt['Site'].nunique())

    c_left, c_right = st.columns(2)
    with c_left:
        st.plotly_chart(px.bar(df_filt, x="Supplier", y="Quantity", color="Site", title="Volume par Fournisseur"), use_container_width=True)
    with c_right:
        st.plotly_chart(px.pie(df_filt, values="Quantity", names="Failures", title="R√©partition des D√©fauts"), use_container_width=True)

    st.dataframe(df_filt.sort_values(by="Date", ascending=False), use_container_width=True)